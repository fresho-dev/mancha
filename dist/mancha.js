(()=>{"use strict";class t{iterable;constructor(t){this.iterable=t}filter(e){return new t(t.filterGenerator(e,this.iterable))}map(e){return new t(t.mapGenerator(e,this.iterable))}find(t){for(const e of this.iterable)if(t(e))return e}array(){return Array.from(this.iterable)}*generator(){for(const t of this.iterable)yield t}static*filterGenerator(t,e){for(const s of e)t(s)&&(yield s)}static*mapGenerator(t,e){for(const s of e)yield t(s)}static equals(t,e){const s=t[Symbol.iterator](),n=e[Symbol.iterator]();let r=s.next(),i=n.next();for(;!r.done&&!i.done;){if(r.value!==i.value)return!1;r=s.next(),i=n.next()}return r.done===i.done}}var e,s;(s=e||(e={})).Root="root",s.Text="text",s.Directive="directive",s.Comment="comment",s.Script="script",s.Style="style",s.Tag="tag",s.CDATA="cdata",s.Doctype="doctype",e.Root,e.Text,e.Directive,e.Comment,e.Script,e.Style,e.Tag,e.CDATA,e.Doctype;class n{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(t){this.parent=t}get previousSibling(){return this.prev}set previousSibling(t){this.prev=t}get nextSibling(){return this.next}set nextSibling(t){this.next=t}cloneNode(t=!1){return d(this,t)}}class r extends n{constructor(t){super(),this.data=t}get nodeValue(){return this.data}set nodeValue(t){this.data=t}}class i extends r{constructor(){super(...arguments),this.type=e.Text}get nodeType(){return 3}}class o extends r{constructor(){super(...arguments),this.type=e.Comment}get nodeType(){return 8}}class a extends r{constructor(t,s){super(s),this.name=t,this.type=e.Directive}get nodeType(){return 1}}class c extends n{constructor(t){super(),this.children=t}get firstChild(){var t;return null!==(t=this.children[0])&&void 0!==t?t:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(t){this.children=t}}class l extends c{constructor(){super(...arguments),this.type=e.CDATA}get nodeType(){return 4}}class h extends c{constructor(){super(...arguments),this.type=e.Root}get nodeType(){return 9}}class u extends c{constructor(t,s,n=[],r=("script"===t?e.Script:"style"===t?e.Style:e.Tag)){super(n),this.name=t,this.attribs=s,this.type=r}get nodeType(){return 1}get tagName(){return this.name}set tagName(t){this.name=t}get attributes(){return Object.keys(this.attribs).map((t=>{var e,s;return{name:t,value:this.attribs[t],namespace:null===(e=this["x-attribsNamespace"])||void 0===e?void 0:e[t],prefix:null===(s=this["x-attribsPrefix"])||void 0===s?void 0:s[t]}}))}}function d(t,s=!1){let n;if(function(t){return t.type===e.Text}(t))n=new i(t.data);else if(function(t){return t.type===e.Comment}(t))n=new o(t.data);else if(function(t){return(s=t).type===e.Tag||s.type===e.Script||s.type===e.Style;var s}(t)){const e=s?f(t.children):[],r=new u(t.name,{...t.attribs},e);e.forEach((t=>t.parent=r)),null!=t.namespace&&(r.namespace=t.namespace),t["x-attribsNamespace"]&&(r["x-attribsNamespace"]={...t["x-attribsNamespace"]}),t["x-attribsPrefix"]&&(r["x-attribsPrefix"]={...t["x-attribsPrefix"]}),n=r}else if(function(t){return t.type===e.CDATA}(t)){const e=s?f(t.children):[],r=new l(e);e.forEach((t=>t.parent=r)),n=r}else if(function(t){return t.type===e.Root}(t)){const e=s?f(t.children):[],r=new h(e);e.forEach((t=>t.parent=r)),t["x-mode"]&&(r["x-mode"]=t["x-mode"]),n=r}else{if(!function(t){return t.type===e.Directive}(t))throw new Error(`Not implemented yet: ${t.type}`);{const e=new a(t.name,t.data);null!=t["x-name"]&&(e["x-name"]=t["x-name"],e["x-publicId"]=t["x-publicId"],e["x-systemId"]=t["x-systemId"]),n=e}}return n.startIndex=t.startIndex,n.endIndex=t.endIndex,null!=t.sourceCodeLocation&&(n.sourceCodeLocation=t.sourceCodeLocation),n}function f(t){const e=t.map((t=>d(t,!0)));for(let t=1;t<e.length;t++)e[t].prev=e[t-1],e[t-1].next=e[t];return e}function*p(t,e=new Set){const s=new Set,n=Array.from(t.childNodes).filter((t=>!e.has(t)));for(yield t;n.length;){const t=n.shift();s.has(t)||(s.add(t),yield t),t.childNodes&&Array.from(t.childNodes).filter((t=>!e.has(t))).forEach((t=>n.push(t)))}}function m(t,e){return"function"==typeof t?.[e]}function g(t,e){return t instanceof u?t.attribs?.[e]:t.getAttribute?.(e)}function y(t,e,s){t instanceof u?t.attribs[e]=s:t.setAttribute?.(e,s)}function b(t,e){t instanceof u?delete t.attribs[e]:t.removeAttribute?.(e)}function w(t,e,s){if(t instanceof u&&e instanceof u)e.attribs[s]=t.attribs[s];else{const n=t?.getAttributeNode?.(s);e?.setAttributeNode?.(n?.cloneNode(!0))}}function v(t,...e){if(m(t,"replaceWith"))return t.replaceWith(...e);{const s=t,n=s.parentNode,r=Array.from(n.childNodes).indexOf(s);e.forEach((t=>t.parentNode=n)),n.childNodes=[].concat(Array.from(n.childNodes).slice(0,r)).concat(e).concat(Array.from(n.childNodes).slice(r+1))}}function x(t,e){return m(e,"appendChild")?t.appendChild(e):(t.childNodes.push(e),e.parentNode=t,e)}function N(t,e){if(m(e,"removeChild"))return t.removeChild(e);{const s=e;return t.childNodes=t.children.filter((t=>t!==s)),s}}function $(t,e,s){return s?m(t,"insertBefore")?t.insertBefore(e,s):(v(s,e,s),e):x(t,e)}window.htmlparser2;class A{timeouts=new Map;debounce(t,e){return new Promise(((s,n)=>{const r=this.timeouts.get(e);r&&clearTimeout(r),this.timeouts.set(e,setTimeout((()=>{try{s(e()),this.timeouts.delete(e)}catch(t){n(t)}}),t))}))}}class C extends A{evalkeys=["$elem","$event"];expressionCache=new Map;store=new Map;observers=new Map;_observer=null;_lock=Promise.resolve();constructor(t){super();for(let[e,s]of Object.entries(t||{}))this.set(e,s)}wrapFunction(t){return(...e)=>t.call(this.$,...e)}wrapObject(t,e){return new Proxy(t,{deleteProperty:(t,s)=>s in t&&(delete t[s],e(),!0),set:(s,n,r,i)=>{"object"==typeof r&&null!=t&&(r=this.wrapObject(r,e));const o=Reflect.set(s,n,r,i);return e(),o},get:(t,e,s)=>"__is_proxy__"===e||Reflect.get(t,e,s)})}watch(t,e){this.observers.has(t)||this.observers.set(t,new Set),this.observers.get(t)?.has(e)||this.observers.get(t)?.add(e)}async notify(t){const e=Array.from(this.observers.get(t)||[]);await this.debounce(10,(()=>Promise.all(e.map((t=>t.call(this.proxify(t)))))))}get(t,e){return e&&this.watch(t,e),this.store.get(t)}async set(t,e){if(e===this.store.get(t))return;const s=()=>this.notify(t);e&&"function"==typeof e&&(e=this.wrapFunction(e)),e&&"object"==typeof e&&(e=this.wrapObject(e,s)),this.store.set(t,e),await s()}del(t){this.store.delete(t),this.observers.delete(t)}has(t){return this.store.has(t)}effect(t){return t.call(this.proxify(t))}proxify(t){const e=Array.from(this.store.entries()).map((([t])=>t)),s=Object.fromEntries(e.map((t=>[t,void 0])));return new Proxy(s,{get:(e,s,n)=>"string"==typeof s&&this.store.has(s)?this.get(s,t):"$"===s?this.proxify(t):Reflect.get(this,s,n),set:(t,e,s,n)=>("string"!=typeof e||e in this?Reflect.set(this,e,s,n):this.set(e,s),!0)})}get $(){return this.proxify()}cachedExpressionFunction(t){return this.expressionCache.has(t)||this.expressionCache.set(t,function(t,e=[]){return new Function(...e,`with (this) { return (${t}); }`)}(t,this.evalkeys)),this.expressionCache.get(t)}eval(t,e={}){const s=this._observer?this:this.$;if(this.store.has(t))return s[t];{const n=this.cachedExpressionFunction(t),r=this.evalkeys.map((t=>e[t]));if(Object.keys(e).some((t=>!this.evalkeys.includes(t))))throw new Error(`Invalid argument key, must be one of: ${this.evalkeys.join(", ")}`);return n.call(s,...r)}}}const E=new Set([":bind",":bind-events",":data",":for",":show","@watch","$html"]);var k;function _(t){return t.includes("/")?t.split("/").slice(0,-1).join("/"):""}function S(t){return!(t.includes("://")||t.startsWith("/")||t.startsWith("#")||t.startsWith("data:"))}!function(e){e.resolveIncludes=async function(t,e){const s=t;if("include"!==s.tagName?.toLocaleLowerCase())return;this.log("<include> tag found in:\n",t),this.log("<include> params:",e);const n=g(s,"src");if(!n)throw new Error(`"src" attribute missing from ${t}.`);const r=e=>{const n=e.firstChild;for(const t of Array.from(s.attributes))n&&"src"!==t.name&&w(s,n,t.name);v(t,...e.childNodes)},i={...e,root:!1,maxdepth:e?.maxdepth-1};if(0===i.maxdepth)throw new Error("Maximum recursion depth reached.");if(n.includes("://")||n.startsWith("//"))this.log("Including remote file from absolute path:",n),await this.preprocessRemote(n,i).then(r);else if(e?.dirpath?.includes("://")||e?.dirpath?.startsWith("//")){const t=n.startsWith("/")?n:`${e.dirpath}/${n}`;this.log("Including remote file from relative path:",t),await this.preprocessRemote(t,i).then(r)}else if("/"===n.charAt(0))this.log("Including local file from absolute path:",n),await this.preprocessLocal(n,i).then(r);else{const t=e?.dirpath&&"."!==e?.dirpath?`${e?.dirpath}/${n}`:n;this.log("Including local file from relative path:",t),await this.preprocessLocal(t,i).then(r)}},e.rebaseRelativePaths=async function(t,e){const s=t,n=s.tagName?.toLowerCase();if(!e?.dirpath)return;const r=g(s,"src"),i=g(s,"href"),o=g(s,"data"),a=r||i||o;a&&(a&&S(a)&&this.log("Rebasing relative path as:",e.dirpath,"/",a),"img"===n&&r&&S(r)?y(s,"src",`${e.dirpath}/${r}`):"a"===n&&i&&S(i)||"link"===n&&i&&S(i)?y(s,"href",`${e.dirpath}/${i}`):"script"===n&&r&&S(r)||"source"===n&&r&&S(r)||"audio"===n&&r&&S(r)||"video"===n&&r&&S(r)||"track"===n&&r&&S(r)||"iframe"===n&&r&&S(r)?y(s,"src",`${e.dirpath}/${r}`):"object"===n&&o&&S(o)?y(s,"data",`${e.dirpath}/${o}`):"input"===n&&r&&S(r)?y(s,"src",`${e.dirpath}/${r}`):("area"===n&&i&&S(i)||"base"===n&&i&&S(i))&&y(s,"href",`${e.dirpath}/${i}`))},e.registerCustomElements=async function(t,e){const s=t;if("template"===s.tagName?.toLowerCase()&&g(s,"is")){const t=g(s,"is")?.toLowerCase();this._customElements.has(t)||(this.log(`Registering custom element: ${t}\n`,s),this._customElements.set(t,s.cloneNode(!0)),N(s.parentNode,s))}},e.resolveCustomElements=async function(e,s){const n=e,r=n.tagName?.toLowerCase();if(this._customElements.has(r)){this.log(`Processing custom element: ${r}\n`,n);const s=this._customElements.get(r),i=(s.content||s).cloneNode(!0),o=function(t){return t instanceof u?t.children.find((t=>t instanceof u)):t.firstElementChild}(i);for(const t of Array.from(n.attributes))o&&w(n,o,t.name);const a=new t(p(i)).find((t=>"slot"===t.tagName?.toLowerCase()));a&&v(a,...n.childNodes),v(e,...i.childNodes)}},e.resolveTextNodeExpressions=async function(t,e){if(3!==t.nodeType)return;const s=function(t){return t instanceof n?t.data:t.nodeValue}(t)||"";this.log("Processing node content value:\n",s);const r=new RegExp(/{{ ([^}]+) }}/gm),i=Array.from(s.matchAll(r)).map((t=>t[1]));return this.effect((function(){let e=s;for(const s of i){const n=this.eval(s,{$elem:t});e=e.replace(`{{ ${s} }}`,String(n))}!function(t,e){t instanceof n?t.data=e:t.nodeValue=e}(t,e)}))},e.resolveDataAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,":data");if(n){this.log(":data attribute found in:\n",t),b(s,":data");const r=this.clone();t.renderer=r;const i=function(t,e=[]){return new Function(...e,`with (this) { return (async () => (${t}))(); }`)}(n,this.evalkeys),o=await i.call(r.$,{$elem:t});await Promise.all(Object.entries(o).map((([t,e])=>r.set(t,e))));for(const e of p(t,this._skipNodes))this._skipNodes.add(e);await r.mount(t,e)}},e.resolveWatchAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,"@watch");n&&(this.log("@watch attribute found in:\n",t),b(s,"@watch"),await this.effect((function(){return this.eval(n,{$elem:t})})))},e.resolveTextAttributes=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,"$text");return n?(this.log("$text attribute found in:\n",t),b(s,"$text"),this.effect((function(){!function(t,e){t instanceof u?t.children=[new i(e)]:t.textContent=e}(t,this.eval(n,{$elem:t}))}))):void 0},e.resolveHtmlAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,"$html");return n?(this.log("$html attribute found in:\n",t.outerHTML),b(s,"$html"),this.effect((function(){const r=this.eval(n,{$elem:t});return new Promise((async t=>{const n=await this.preprocessString(r,e);await this.renderNode(n),function(t,...e){m(t,"replaceChildren")?t.replaceChildren(...e):(t.childNodes=e,e.forEach((e=>e.parentNode=t)))}(s,n),t()}))}))):void 0},e.resolvePropAttributes=async function(t,e){if(this._skipNodes.has(t))return;const s=t;for(const e of Array.from(s.attributes||[]))if(e.name.startsWith("$")&&!E.has(e.name)){this.log(e.name,"attribute found in:\n",t),b(s,e.name);const n=e.name.slice(1).replace(/-./g,(t=>t[1].toUpperCase()));await this.effect((function(){t[n]=this.eval(e.value,{$elem:t})}))}},e.resolveAttrAttributes=async function(t,e){if(this._skipNodes.has(t))return;const s=t;for(const e of Array.from(s.attributes||[]))if(e.name.startsWith(":")&&!E.has(e.name)){this.log(e.name,"attribute found in:\n",t),b(s,e.name);const n=e.name.slice(1);this.effect((function(){y(s,n,this.eval(e.value,{$elem:t}))}))}},e.resolveEventAttributes=async function(t,e){if(this._skipNodes.has(t))return;const s=t;for(const e of Array.from(s.attributes||[]))e.name.startsWith("@")&&!E.has(e.name)&&(this.log(e.name,"attribute found in:\n",t),b(s,e.name),t.addEventListener?.(e.name.substring(1),(s=>{this.eval(e.value,{$elem:t,$event:s})})))},e.resolveForAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,":for")?.trim();if(n){this.log(":for attribute found in:\n",t),b(s,":for");for(const e of p(t,this._skipNodes))this._skipNodes.add(e);const r=t.parentNode,i=function(t,e){return e?e.createElement(t):new u(t,{})}("template",t.ownerDocument);$(r,i,t),N(r,t),x(i,t),this.log(":for template:\n",i);const o=n.split(" in ",2);if(2!==o.length)throw new Error(`Invalid :for format: \`${n}\`. Expected "{key} in {expression}".`);const a=[],[c,l]=o;await this.effect((function(){const s=this.eval(l,{$elem:t});if(this.log(":for list items:",s),a.splice(0,a.length).forEach((t=>{N(r,t),this._skipNodes.delete(t)})),!Array.isArray(s))return console.error(`Expression did not yield a list: \`${l}\` => \`${s}\``),Promise.resolve();const n=[];for(const r of s){const s=this.clone();s.set(c,r);const i=t.cloneNode(!0);a.push(i),this._skipNodes.add(i),n.push(s.mount(i,e)),this.log("Rendered list child:\n",i.outerHTML)}const o=i.nextSibling;for(const t of a)$(r,t,o);return Promise.all(n)}))}},e.resolveBindAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,":bind");if(n){this.log(":bind attribute found in:\n",t);const e=["change","input"],r=g(s,":bind-events")?.split(",")||e;b(s,":bind"),b(s,":bind-events");const i="checkbox"===g(s,"type")?"checked":"value",o=`$elem.${i} = ${n}`;this.effect((function(){const e=this.eval(o,{$elem:t});s[i]=e}));const a=`${n} = $elem.${i}`;for(const e of r)t.addEventListener(e,(()=>this.eval(a,{$elem:t})))}},e.resolveShowAttribute=async function(t,e){if(this._skipNodes.has(t))return;const s=t,n=g(s,":show");if(n){this.log(":show attribute found in:\n",t),b(s,":show");const e="none"===s.style?.display?"":s.style?.display??g(s,"style")?.split(";")?.find((t=>"display"===t.split(":")[0]))?.split(":")?.at(1)?.trim();this.effect((function(){const r=this.eval(n,{$elem:t});s.style?s.style.display=r?e:"none":y(s,"style",`display: ${r?e:"none"};`)}))}}}(k||(k={}));class T extends C{debugging=!1;dirpath="";_skipNodes=new Set;_customElements=new Map;debug(t){return this.debugging=t,this}async fetchRemote(t,e){return fetch(t,{cache:e?.cache??"default"}).then((t=>t.text()))}async fetchLocal(t,e){return this.fetchRemote(t,e)}async preprocessString(t,e){this.log("Preprocessing string content with params:\n",e);const s=this.parseHTML(t,e);return await this.preprocessNode(s,e),s}async preprocessRemote(t,e){const s={};e?.cache&&(s.cache=e.cache);const n=await fetch(t,s).then((t=>t.text()));return this.preprocessString(n,{...e,dirpath:_(t),root:e?.root??!t.endsWith(".tpl.html")})}async preprocessLocal(t,e){const s=await this.fetchLocal(t,e);return this.preprocessString(s,{...e,dirpath:_(t),root:e?.root??!t.endsWith(".tpl.html")})}clone(){const t=new this.constructor(Object.fromEntries(this.store.entries()));return t._customElements=this._customElements,t.debug(this.debugging)}log(...t){this.debugging&&console.debug(...t)}async preprocessNode(e,s){s=Object.assign({dirpath:this.dirpath,maxdepth:10},s);const n=new t(p(e,this._skipNodes)).map((async t=>{this.log("Preprocessing node:\n",t.outerHTML),await k.resolveIncludes.call(this,t,s),await k.rebaseRelativePaths.call(this,t,s),await k.registerCustomElements.call(this,t,s),await k.resolveCustomElements.call(this,t,s)}));return await Promise.all(n.generator()),e}async renderNode(t,e){for(const s of p(t,this._skipNodes))this.log("Rendering node:\n",s.outerHTML),await k.resolveDataAttribute.call(this,s,e),await k.resolveForAttribute.call(this,s,e),await k.resolveTextAttributes.call(this,s,e),await k.resolveHtmlAttribute.call(this,s,e),await k.resolveShowAttribute.call(this,s,e),await k.resolveWatchAttribute.call(this,s,e),await k.resolveBindAttribute.call(this,s,e),await k.resolvePropAttributes.call(this,s,e),await k.resolveAttrAttributes.call(this,s,e),await k.resolveEventAttributes.call(this,s,e),await k.resolveTextNodeExpressions.call(this,s,e);return t}async mount(t,e){await this.preprocessNode(t,e),await this.renderNode(t,e)}}const L=new class extends T{dirpath=_(self.location.href);parseHTML(t,e={root:!1}){if(e.root)return(new DOMParser).parseFromString(t,"text/html");{const e=document.createRange();return e.selectNodeContents(document.body),e.createContextualFragment(t)}}serializeHTML(t){return(new XMLSerializer).serializeToString(t).replace(/\s?xmlns="[^"]+"/gm,"")}preprocessLocal(t,e){return this.preprocessRemote(t,e)}};self.Mancha=L;const P=self.document?.currentScript;if(self.document?.currentScript?.hasAttribute("init")){const t=P?.hasAttribute("debug"),e=P?.getAttribute("cache"),s=P?.getAttribute("target")?.split(",")||["body"];window.addEventListener("load",(()=>{s.map((async s=>{const n=self.document.querySelector(s);await L.debug(t).mount(n,{cache:e})}))}))}})();